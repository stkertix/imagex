#!/bin/bash

# ImageX Deployment Script
# This script builds the application for production and optionally deploys it

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
DEPLOY_PATH="/var/www/html/imagex"
USE_SUDO=true  # Set to false if you have write permission without sudo

# Functions
print_info() {
    echo -e "${BLUE}â„¹${NC} $1"
}

print_success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

print_error() {
    echo -e "${RED}âœ—${NC} $1"
}

# Check if npm is installed
check_dependencies() {
    print_info "Checking dependencies..."
    
    if ! command -v npm &> /dev/null; then
        print_error "npm is not installed. Please install Node.js and npm first."
        exit 1
    fi
    
    print_success "Dependencies check passed"
}

# Install dependencies if needed
install_dependencies() {
    if [ ! -d "node_modules" ]; then
        print_info "Installing dependencies..."
        npm install
        print_success "Dependencies installed"
    else
        print_info "Dependencies already installed"
    fi
}

# Build the application
build_app() {
    print_info "Building application for production..."
    
    # Clean previous build
    if [ -d "dist" ]; then
        print_info "Cleaning previous build..."
        rm -rf dist
    fi
    
    # Build
    npm run build
    
    if [ -d "dist" ]; then
        print_success "Build completed successfully!"
        print_info "Build output: $(du -sh dist | cut -f1)"
    else
        print_error "Build failed - dist directory not found"
        exit 1
    fi
}

# Deploy to local server
deploy_to_server() {
    print_info "Deploying to ${DEPLOY_PATH}..."
    
    # Check if dist directory exists
    if [ ! -d "dist" ]; then
        print_error "dist directory not found. Please build the application first."
        exit 1
    fi
    
    # Determine if we need sudo
    SUDO_CMD=""
    if [ "$USE_SUDO" = true ]; then
        if command -v sudo &> /dev/null; then
            SUDO_CMD="sudo"
        else
            print_warning "sudo not found, trying without sudo..."
        fi
    fi
    
    # Step 1: Remove existing deployment directory
    print_info "Removing existing directory: ${DEPLOY_PATH}"
    if [ -d "${DEPLOY_PATH}" ]; then
        $SUDO_CMD rm -rf "${DEPLOY_PATH}"
        print_success "Directory removed"
    else
        print_info "Directory does not exist, skipping removal"
    fi
    
    # Step 2: Create parent directory if it doesn't exist
    print_info "Creating deployment directory: ${DEPLOY_PATH}"
    $SUDO_CMD mkdir -p "${DEPLOY_PATH}"
    print_success "Directory created"
    
    # Step 3: Copy build files to deployment directory
    print_info "Copying build files from dist/ to ${DEPLOY_PATH}"
    $SUDO_CMD cp -r dist/* "${DEPLOY_PATH}/"
    print_success "Files copied successfully"
    
    # Set proper permissions (optional, adjust as needed)
    print_info "Setting permissions..."
    $SUDO_CMD chown -R www-data:www-data "${DEPLOY_PATH}" 2>/dev/null || \
    $SUDO_CMD chown -R apache:apache "${DEPLOY_PATH}" 2>/dev/null || \
    print_warning "Could not set ownership (may require manual configuration)"
    
    print_success "Deployment completed!"
    print_info "Application deployed to: ${DEPLOY_PATH}"
}

# Main execution
main() {
    echo ""
    echo "=========================================="
    echo "  ImageX Deployment Script"
    echo "=========================================="
    echo ""
    
    # Parse arguments
    SKIP_BUILD=false
    SKIP_DEPLOY=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --skip-build)
                SKIP_BUILD=true
                shift
                ;;
            --skip-deploy)
                SKIP_DEPLOY=true
                shift
                ;;
            --build-only)
                SKIP_DEPLOY=true
                shift
                ;;
            --deploy-only)
                SKIP_BUILD=true
                shift
                ;;
            -h|--help)
                echo "Usage: ./deploy [options]"
                echo ""
                echo "Options:"
                echo "  --skip-build      Skip building the application"
                echo "  --skip-deploy     Skip deployment to server"
                echo "  --build-only      Only build, don't deploy"
                echo "  --deploy-only     Only deploy, don't build (requires existing dist/)"
                echo "  --no-sudo         Deploy without using sudo (if you have write permission)"
                echo "  -h, --help        Show this help message"
                echo ""
                echo "Deployment steps:"
                echo "  1. Build production"
                echo "  2. Remove directory: ${DEPLOY_PATH}"
                echo "  3. Copy dist/ to: ${DEPLOY_PATH}"
                echo ""
                echo "To configure deployment path, edit the script and set:"
                echo "  DEPLOY_PATH (default: /var/www/html/imagex)"
                exit 0
                ;;
            --no-sudo)
                USE_SUDO=false
                shift
                ;;
            *)
                print_error "Unknown option: $1"
                echo "Use --help for usage information"
                exit 1
                ;;
        esac
    done
    
    # Run steps
    check_dependencies
    
    if [ "$SKIP_BUILD" = false ]; then
        install_dependencies
        build_app
    else
        if [ ! -d "dist" ]; then
            print_error "dist directory not found. Run build first or remove --skip-build flag."
            exit 1
        fi
        print_info "Skipping build (using existing dist/)"
    fi
    
    if [ "$SKIP_DEPLOY" = false ]; then
        deploy_to_server
    else
        print_info "Skipping deployment"
    fi
    
    echo ""
    echo "=========================================="
    print_success "All done! ðŸŽ‰"
    echo "=========================================="
    echo ""
    if [ "$SKIP_DEPLOY" = false ]; then
        print_info "Application deployed to: ${DEPLOY_PATH}"
        print_info "Application will be available at: https://domain.com/imagex/"
    else
        print_info "Build output is in: ./dist/"
        print_info "Run './deploy --deploy-only' to deploy to ${DEPLOY_PATH}"
    fi
    echo ""
}

# Run main function
main "$@"
